# Dev State — 2025-08-24

## Overview
We have reached a working Proof of Concept (PoC) for the infertility platform:
- **Network Admin** app: allows networks to publish bundles of assessment questions.
- **API** (Fastify + Prisma + Postgres): manages networks, practices, patients, bundles, and encrypted submissions.
- **Patient App**: loads current bundle, validates input, encrypts answers client-side, and syncs securely to API.
- **Doctor Decrypt PoC**: practice can unwrap DEK with private key and decrypt submissions offline.

This demonstrates end-to-end flow:
**Patient → encrypted commit → API → Doctor decrypt.**

---

## Services
- **API**: `pnpm dev` in `apps/api` → http://127.0.0.1:8787
- **Network Admin**: `pnpm dev` in `apps/network-admin` → http://localhost:5173
- **Patient App**: `pnpm dev -- --host 127.0.0.1 --port 5181` in `apps/patient-app` (auto-shifts if port busy)

---

## Database / Schema
- Postgres 16 via Homebrew (`brew services start postgresql@16`)
- Prisma schema includes: Org, Network, Practice, PracticeKey, Patient, CareEpisode, Bundle, Submission.
- Seed script `prisma/seed_bootstrap.ts` inserts:
  - Org: *Artisan Fertility Corporate*
  - Network: *Demo Network*
  - Practice: *Demo OB/GYN*
  - Patient: `patient_demo_001`
  - Active care episode for patient
  - PracticeKey seeded and rotated to 2048-bit RSA

---

## Crypto / Security
- Submissions encrypted on patient device:
  - Generate DEK (32 bytes)
  - AES-256-GCM encrypt payload (answers + bundle metadata)
  - Wrap DEK for each recipient:
    - Patient (placeholder)
    - Practice (RSA-OAEP with SHA-256, 2048-bit key)
- API stores ciphertext, iv, tag, wrapped keys
- Doctor fetches blob, unwraps DEK with private key, decrypts AES-GCM

---

## Key Steps Accomplished
1. Installed pnpm, Vite, Tailwind v4, Prisma.
2. Bootstrapped monorepo with apps: `network-admin`, `api`, `patient-app`.
3. Configured Postgres + Prisma schema and migrations.
4. Created seed scripts for org/network/practice/patient.
5. Rotated demo practice key to 2048-bit RSA (critical for WebCrypto).
6. Patient App:
   - Fetches active network bundle via API.
   - Renders questions (radio/checkbox/textarea) with validation.
   - Commits encrypted submission.
7. API endpoints working:
   - `/networks`, `/networks/:id/practices`
   - `/networks/:id/bundles` (publish)
   - `/networks/:id/current` (active bundle pointer)
   - `/patients/:id/submissions`
   - `/submissions/:id/blob`
8. Doctor CLI decrypt script:
   - Reads blob (ciphertext/iv/tag/wrappedDEK as CSV bytes).
   - Unwraps DEK with practice private key.
   - Decrypts AES-GCM payload to recover answers.

---

## Files Added
- `apps/patient-app/src/modules/sync/patientSync.ts` — encrypt & upload helper
- `apps/patient-app/src/modules/bundles/api.ts` — fetch care/networks/bundle
- `apps/patient-app/src/modules/bundles/renderer.tsx` — render + validate questions
- `apps/patient-app/src/App.tsx` — integrated live bundle flow
- `apps/api/prisma/rotate_practice_key.ts` — rotate/activate new practice RSA key
- `doctor_decrypt.mjs` — doctor CLI decrypt script

---

## Known Issues / Fixes
- Tailwind v4 config requires `postcss.config.js` with `@tailwindcss/postcss`.
- Publishing via Network Admin UI still fails (export hook missing) → workaround: publish via API `POST /networks/:id/bundles`.
- WebCrypto error “operation-specific reason” → caused by weak (512-bit) RSA key → fixed with 2048-bit key rotation.
- “auth required” error → caused by missing `x-practice-id` header in curl → fix by setting PRACTICE_ID env var.

---

## Next Steps
- Fix Network Admin FormBuilder export so bundles can publish via UI.
- Implement practice-assigned bundles (not just network current).
- Add offline queue + retry in patient app.
- Add corporate layer: propagate default bundles to networks.
- Doctor portal UI: integrate decrypt logic securely (no CLI).
- Finalize patient-held PHI with corporate cloud backup.
- Expand schema to support treatment planning and educational library modules.

